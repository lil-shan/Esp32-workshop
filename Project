#include <WiFi.h>
#include <WebServer.h>
#include "DHT.h"

// --------- Sensor Pins ------------
#define DHTPIN 26        // DHT11 data pin
#define DHTTYPE DHT11   // Sensor type
#define IR_PIN 25       // IR sensor output pin

// --------- WiFi SoftAP Credentials ------------
const char* ssid = "RoomMonitor";     
const char* password = "12345678";    

// --------- Objects ------------
DHT dht(DHTPIN, DHTTYPE);
WebServer server(80);

// --------- Handle Main Page (HTML + JS) ------------
void handleRoot() {
  String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
  html += "<title>ESP32 Room Monitor</title>";
  html += "<style>body{font-family:Arial;text-align:center;background:#f4f4f4;}";
  html += "h1{color:#333;} .card{background:#fff;padding:20px;margin:20px;display:inline-block;";
  html += "border-radius:10px;box-shadow:0px 0px 10px #aaa;}</style></head><body>";

  html += "<h1>ESP32 Room Monitor</h1>";
  html += "<div id='temp' class='card'><h2>Temperature: -- °C</h2></div>";
  html += "<div id='hum' class='card'><h2>Humidity: -- %</h2></div>";
  html += "<div id='motion' class='card'><h2>Status: --</h2></div>";

  // JavaScript for real-time updates
  html += "<script>";
  html += "function updateData(){";
  html += "fetch('/data').then(r=>r.json()).then(d=>{";
  html += "document.getElementById('temp').innerHTML='<h2>Temperature: '+d.temperature+' °C</h2>'; ";
  html += "document.getElementById('hum').innerHTML='<h2>Humidity: '+d.humidity+' %</h2>'; ";
  html += "if(d.motion==1){";
  html += "document.getElementById('motion').innerHTML='<h2 style=\"color:red;\">Motion Detected</h2>';}";
  html += "else{document.getElementById('motion').innerHTML='<h2 style=\"color:green;\">No Motion Detected</h2>';}";
  html += "});}";
  html += "setInterval(updateData, 1000);"; // update every second
  html += "updateData();"; // run once on load
  html += "</script>";

  html += "</body></html>";
  server.send(200, "text/html", html);
}

// --------- Handle JSON Data for AJAX ------------
void handleData() {
  float h = dht.readHumidity();
  float t = dht.readTemperature();
  int irStatus = digitalRead(IR_PIN);

  // Fallback in case DHT fails
  if (isnan(h) || isnan(t)) {
    h = 0;
    t = 0;
  }

  String json = "{";
  json += "\"temperature\":" + String(t) + ",";
  json += "\"humidity\":" + String(h) + ",";
  json += "\"motion\":" + String(irStatus == LOW ? 1 : 0);
  json += "}";

  server.send(200, "application/json", json);
}

void setup() {
  Serial.begin(115200);
  dht.begin();
  pinMode(IR_PIN, INPUT);

  // Start SoftAP
  WiFi.softAP(ssid, password);
  Serial.println("ESP32 started as SoftAP");
  Serial.print("SSID: "); Serial.println(ssid);
  Serial.print("IP Address: "); Serial.println(WiFi.softAPIP());

  // Routes
  server.on("/", handleRoot);
  server.on("/data", handleData);

  server.begin();
  Serial.println("Web server started");
}

void loop() {
  server.handleClient();
}
